# üìã GUIA COMPLETO DE INTEGRA√á√ÉO DAS TABELAS - FLUYT COMERCIAL

Este documento define **todos os aspectos necess√°rios** para integrar as demais tabelas do sistema, usando a tabela **Clientes** como modelo de refer√™ncia perfeito.

---

## üéØ **OBJETIVO**

Criar um **padr√£o consistente** para integra√ß√£o de todas as tabelas, garantindo:
- **Conectividade completa:** Frontend ‚Üî Backend ‚Üî Supabase
- **Hierarquia de dados** respeitada
- **Autentica√ß√£o e autoriza√ß√£o** adequadas
- **C√≥digo limpo e manuten√≠vel**
- **Escalabilidade** para futuras tabelas

---

## üìä **MAPEAMENTO COMPLETO DAS TABELAS**

### **üîµ TABELAS PRINCIPAIS (Alta Prioridade)**
1. **`cad_empresas`** - Empresas do sistema
2. **`c_lojas`** - Lojas das empresas
3. **`cad_equipe`** - Funcion√°rios/Equipe
4. **`cad_setores`** - Setores organizacionais
5. **`cad_procedencias`** - Origem dos clientes
6. **`cad_montadores`** - Prestadores de montagem
7. **`cad_transportadoras`** - Empresas de transporte

### **üü° TABELAS DE CONFIGURA√á√ÉO (M√©dia Prioridade)**
8. **`config_loja`** - Configura√ß√µes por loja
9. **`config_status_orcamento`** - Status dos or√ßamentos
10. **`config_regras_comissao_faixa`** - Regras de comiss√£o

### **üü¢ TABELAS OPERACIONAIS (Baixa Prioridade Inicial)**
11. **`c_orcamentos`** - Or√ßamentos
12. **`c_ambientes`** - Ambientes dos or√ßamentos
13. **`c_contratos`** - Contratos gerados
14. **`c_aprovacao_historico`** - Hist√≥rico de aprova√ß√µes

---

## üèóÔ∏è **ARQUITETURA PADR√ÉO DE INTEGRA√á√ÉO**

### **üìÅ ESTRUTURA DE ARQUIVOS (Para cada tabela)**

```
Backend:
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îî‚îÄ‚îÄ [nome_tabela]/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ controller.py      # Endpoints da API
‚îÇ       ‚îú‚îÄ‚îÄ services.py        # L√≥gica de neg√≥cio
‚îÇ       ‚îú‚îÄ‚îÄ repository.py      # Acesso aos dados
‚îÇ       ‚îî‚îÄ‚îÄ schemas.py         # Valida√ß√£o de dados

Frontend:
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/modulos/[nome_tabela]/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [tabela]-page.tsx        # P√°gina principal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [tabela]-form.tsx        # Formul√°rio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [tabela]-table.tsx       # Tabela de listagem
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [tabela]-actions.tsx     # A√ß√µes (editar, excluir)
‚îÇ   ‚îú‚îÄ‚îÄ hooks/modulos/[nome_tabela]/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ use-[tabela]-api.ts      # Hook principal da API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ use-[tabela]-form.ts     # Hook do formul√°rio
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [tabela].ts              # Tipos TypeScript
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ [tabela]-service.ts      # Servi√ßo de API
```

---

## üîê **AUTENTICA√á√ÉO E HIERARQUIA**

### **N√çVEIS DE ACESSO POR PERFIL**

```typescript
SUPER_ADMIN:
  - Acesso total a todas as tabelas
  - Pode ver dados de todas as lojas/empresas
  - loja_id = null (sem filtro)

ADMIN:
  - Acesso a dados da empresa
  - Filtrado por empresa_id
  
GERENTE:
  - Acesso a dados da loja
  - Filtrado por loja_id
  
VENDEDOR:
  - Acesso limitado (s√≥ seus dados)
  - Filtrado por loja_id + user_id
```

### **IMPLEMENTA√á√ÉO NO BACKEND**

```python
# services.py - Padr√£o para todas as tabelas
async def listar_[tabela](self, user: User, filtros, pagination):
    # Hierarquia de acesso
    if user.perfil == "SUPER_ADMIN":
        filtro_hierarquia = None  # V√™ tudo
    elif user.perfil == "ADMIN":
        filtro_hierarquia = {"empresa_id": user.empresa_id}
    elif user.perfil == "GERENTE":
        filtro_hierarquia = {"loja_id": user.loja_id}
    else:
        filtro_hierarquia = {"loja_id": user.loja_id, "user_id": user.id}
    
    return await repository.listar(filtro_hierarquia, filtros, pagination)
```

---

## üóÑÔ∏è **CONFIGURA√á√ÉO SUPABASE**

### **RLS (Row Level Security) - PADR√ÉO**

```sql
-- Para cada tabela, criar pol√≠tica baseada na hierarquia
CREATE POLICY "policy_[tabela]_select" ON public.[tabela]
FOR SELECT USING (
  CASE 
    WHEN auth.jwt() ->> 'perfil' = 'SUPER_ADMIN' THEN true
    WHEN auth.jwt() ->> 'perfil' = 'ADMIN' THEN 
      empresa_id = (auth.jwt() ->> 'empresa_id')::uuid
    WHEN auth.jwt() ->> 'perfil' = 'GERENTE' THEN 
      loja_id = (auth.jwt() ->> 'loja_id')::uuid
    ELSE 
      loja_id = (auth.jwt() ->> 'loja_id')::uuid 
      AND created_by = (auth.jwt() ->> 'user_id')::uuid
  END
);
```

### **RELACIONAMENTOS OBRIGAT√ìRIOS**

```sql
-- Toda tabela deve ter:
ALTER TABLE [tabela] ADD COLUMN IF NOT EXISTS loja_id UUID REFERENCES c_lojas(id);
ALTER TABLE [tabela] ADD COLUMN IF NOT EXISTS created_by UUID;
ALTER TABLE [tabela] ADD COLUMN IF NOT EXISTS created_at TIMESTAMPTZ DEFAULT NOW();
ALTER TABLE [tabela] ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();
```

---

## üé® **FRONTEND - PADR√ïES DE COMPONENTES**

### **HOOK PRINCIPAL (use-[tabela]-api.ts)**

```typescript
export const use[Tabela]Api = () => {
  const [data, setData] = useState<[Tabela][]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const listar = async (filtros?: Filtros[Tabela]) => {
    setLoading(true);
    try {
      const response = await [tabela]Service.listar(filtros);
      setData(response.items);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };
  
  const criar = async (dados: [Tabela]Create) => {
    // Implementa√ß√£o padr√£o
  };
  
  const atualizar = async (id: string, dados: [Tabela]Update) => {
    // Implementa√ß√£o padr√£o
  };
  
  const excluir = async (id: string) => {
    // Implementa√ß√£o padr√£o
  };
  
  return { data, loading, error, listar, criar, atualizar, excluir };
};
```

### **COMPONENTE DE P√ÅGINA ([tabela]-page.tsx)**

```typescript
export const [Tabela]Page = () => {
  const { data, loading, listar, criar, atualizar, excluir } = use[Tabela]Api();
  const [showForm, setShowForm] = useState(false);
  const [editingItem, setEditingItem] = useState<[Tabela] | null>(null);
  
  useEffect(() => {
    listar();
  }, []);
  
  return (
    <div className="space-y-6">
      <SectionHeader 
        title="[Nome da Tabela]"
        subtitle="Gerenciamento de [descri√ß√£o]"
        action={
          <Button onClick={() => setShowForm(true)}>
            <Plus className="w-4 h-4 mr-2" />
            Novo [Item]
          </Button>
        }
      />
      
      {showForm && (
        <[Tabela]Form 
          item={editingItem}
          onSave={(dados) => editingItem ? atualizar(editingItem.id, dados) : criar(dados)}
          onCancel={() => {setShowForm(false); setEditingItem(null);}}
        />
      )}
      
      <[Tabela]Table 
        data={data}
        loading={loading}
        onEdit={(item) => {setEditingItem(item); setShowForm(true);}}
        onDelete={excluir}
      />
    </div>
  );
};
```

---

## üîÑ **FLUXO DE DADOS PADR√ÉO**

### **1. LISTAGEM**
```
Frontend: use[Tabela]Api.listar()
    ‚Üì
Backend: [Tabela]Controller.listar()
    ‚Üì
Backend: [Tabela]Service.listar() (aplica hierarquia)
    ‚Üì
Backend: [Tabela]Repository.listar() (consulta SQL)
    ‚Üì
Supabase: SELECT com RLS aplicado
    ‚Üì
Frontend: Atualiza estado e renderiza
```

### **2. CRIA√á√ÉO**
```
Frontend: Formul√°rio ‚Üí use[Tabela]Api.criar()
    ‚Üì
Backend: [Tabela]Controller.criar() (valida dados)
    ‚Üì
Backend: [Tabela]Service.criar() (aplica regras de neg√≥cio)
    ‚Üì
Backend: [Tabela]Repository.criar() (INSERT)
    ‚Üì
Supabase: Insere com user_id e loja_id autom√°ticos
    ‚Üì
Frontend: Atualiza lista e fecha formul√°rio
```

---

## üìã **CHECKLIST DE INTEGRA√á√ÉO**

### **üóÑÔ∏è SUPABASE**
- [ ] Tabela criada com campos obrigat√≥rios
- [ ] RLS habilitado e pol√≠ticas configuradas
- [ ] Relacionamentos (FKs) criados
- [ ] √çndices de performance adicionados
- [ ] Triggers de auditoria (se necess√°rio)

### **üîß BACKEND**
- [ ] M√≥dulo criado com estrutura padr√£o
- [ ] Schemas com valida√ß√µes adequadas
- [ ] Repository com queries otimizadas
- [ ] Services com l√≥gica de neg√≥cio e hierarquia
- [ ] Controller com endpoints RESTful
- [ ] Testes unit√°rios b√°sicos

### **üé® FRONTEND**
- [ ] Tipos TypeScript definidos
- [ ] Hook de API implementado
- [ ] Servi√ßo de API criado
- [ ] Componentes de p√°gina, form e tabela
- [ ] Integra√ß√£o com sistema de navega√ß√£o
- [ ] Valida√ß√µes de formul√°rio
- [ ] Estados de loading e erro

### **üîê SEGURAN√áA**
- [ ] Autentica√ß√£o obrigat√≥ria
- [ ] Autoriza√ß√£o por perfil implementada
- [ ] Valida√ß√£o de dados no backend
- [ ] Logs de auditoria (se necess√°rio)
- [ ] Rate limiting (se necess√°rio)

---

## üöÄ **ORDEM DE IMPLEMENTA√á√ÉO RECOMENDADA**

### **FASE 1: ESTRUTURA BASE**
1. **`cad_empresas`** - Base da hierarquia
2. **`c_lojas`** - Dependente de empresas
3. **`cad_setores`** - Independente, simples

### **FASE 2: RECURSOS HUMANOS**
4. **`cad_equipe`** - Funcion√°rios
5. **`cad_procedencias`** - Origem dos clientes

### **FASE 3: PRESTADORES**
6. **`cad_montadores`** - Prestadores de montagem
7. **`cad_transportadoras`** - Empresas de transporte

### **FASE 4: CONFIGURA√á√ïES**
8. **`config_loja`** - Configura√ß√µes por loja
9. **`config_status_orcamento`** - Status dos or√ßamentos
10. **`config_regras_comissao_faixa`** - Regras de comiss√£o

---

## üìù **OBSERVA√á√ïES IMPORTANTES**

### **PADR√ïES DE NOMENCLATURA**
- **Tabelas:** `snake_case` (ex: `cad_empresas`)
- **Componentes:** `PascalCase` (ex: `EmpresaPage`)
- **Hooks:** `camelCase` com prefixo `use` (ex: `useEmpresasApi`)
- **Arquivos:** `kebab-case` (ex: `empresa-page.tsx`)

### **VALIDA√á√ïES**
- **Backend:** Sempre validar dados recebidos
- **Frontend:** Validar antes de enviar
- **Supabase:** Constraints de banco como √∫ltima barreira

### **PERFORMANCE**
- **Pagina√ß√£o:** Implementar em todas as listagens
- **Filtros:** Indexar campos filtr√°veis
- **Cache:** Considerar cache para dados est√°ticos

### **MANUTENIBILIDADE**
- **C√≥digo simples:** Priorizar legibilidade
- **Reutiliza√ß√£o:** Componentes gen√©ricos quando poss√≠vel
- **Documenta√ß√£o:** Comentar l√≥gicas complexas
- **Testes:** Cobrir cen√°rios principais

---

## üéØ **RESULTADO ESPERADO**

Ao seguir este guia, cada tabela integrada ter√°:

‚úÖ **Conectividade total** Frontend ‚Üî Backend ‚Üî Supabase
‚úÖ **Hierarquia respeitada** conforme perfil do usu√°rio
‚úÖ **Interface consistente** e intuitiva
‚úÖ **C√≥digo limpo** e manuten√≠vel
‚úÖ **Seguran√ßa adequada** com autentica√ß√£o/autoriza√ß√£o
‚úÖ **Performance otimizada** com pagina√ß√£o e filtros
‚úÖ **Escalabilidade** para futuras funcionalidades

**A tabela Clientes serve como modelo perfeito** - todas as demais devem seguir exatamente os mesmos padr√µes e estruturas implementados nela.
